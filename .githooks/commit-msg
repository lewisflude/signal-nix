#!/usr/bin/env bash
# Conventional Commits validation hook
# https://www.conventionalcommits.org/

set -e

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Allow merge commits
if echo "$commit_msg" | grep -qE "^Merge "; then
    exit 0
fi

# Conventional Commits pattern
pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}$"

if ! echo "$commit_msg" | head -n1 | grep -qE "$pattern"; then
    echo "❌ Invalid commit message format!"
    echo ""
    echo "Commit messages must follow Conventional Commits:"
    echo "  <type>[optional scope]: <description>"
    echo ""
    echo "Types:"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation only"
    echo "  style:    Formatting, missing semicolons, etc"
    echo "  refactor: Code change that neither fixes bug nor adds feature"
    echo "  perf:     Performance improvement"
    echo "  test:     Adding tests"
    echo "  build:    Changes to build system or dependencies"
    echo "  ci:       Changes to CI configuration"
    echo "  chore:    Other changes that don't modify src or test files"
    echo "  revert:   Reverts a previous commit"
    echo ""
    echo "Examples:"
    echo "  feat: add theme module for delta"
    echo "  fix(bat): resolve theme detection issue"
    echo "  docs: update README with new modules"
    echo ""
    echo "Your message:"
    echo "  $commit_msg" | head -n1
    exit 1
fi

# Check that description is not empty and doesn't start with uppercase after colon
first_line=$(echo "$commit_msg" | head -n1)
description=$(echo "$first_line" | sed -E 's/^[^:]+: //')

if [ -z "$description" ]; then
    echo "❌ Commit description cannot be empty!"
    exit 1
fi

if echo "$description" | grep -qE "^[A-Z]"; then
    echo "⚠️  Warning: Commit description should start with lowercase"
    echo "  Current: $description"
    # Allow but warn
fi

exit 0
