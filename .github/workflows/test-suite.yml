name: Test Suite

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run daily at 2am UTC to catch upstream breakages
    - cron: '0 2 * * *'

jobs:
  # Quick smoke test to fail fast on basic issues
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Check flake structure
        run: |
          echo "::group::Flake Metadata"
          nix flake metadata
          echo "::endgroup::"
          
          echo "::group::Flake Structure"
          nix flake show
          echo "::endgroup::"
          
          echo "‚úÖ Flake structure check passed" >> $GITHUB_STEP_SUMMARY

      - name: Run unit tests
        id: unit_tests
        run: |
          echo "::group::Unit Test: resolveThemeMode"
          START=$(date +%s)
          if nix build .#checks.x86_64-linux.unit-lib-resolveThemeMode --print-build-logs; then
            END=$(date +%s)
            DURATION=$((END - START))
            echo "‚úÖ resolveThemeMode test passed (${DURATION}s)"
            echo "::notice title=Unit Test Passed::resolveThemeMode test passed in ${DURATION}s"
          else
            echo "::error title=Unit Test Failed::resolveThemeMode test failed"
            exit 1
          fi
          echo "::endgroup::"
          
          echo "::group::Unit Test: getColors"
          START=$(date +%s)
          if nix build .#checks.x86_64-linux.unit-lib-getColors --print-build-logs; then
            END=$(date +%s)
            DURATION=$((END - START))
            echo "‚úÖ getColors test passed (${DURATION}s)"
            echo "::notice title=Unit Test Passed::getColors test passed in ${DURATION}s"
          else
            echo "::error title=Unit Test Failed::getColors test failed"
            exit 1
          fi
          echo "::endgroup::"
          
          echo "## üî• Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All smoke tests passed" >> $GITHUB_STEP_SUMMARY

  # Main test suite
  test-suite:
    name: Test Suite (${{ matrix.category }}) - ${{ matrix.system }}
    runs-on: ${{ matrix.os }}
    needs: smoke-test
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 - Run all categories
          - system: x86_64-linux
            os: ubuntu-latest
            category: happy
          - system: x86_64-linux
            os: ubuntu-latest
            category: edge
          - system: x86_64-linux
            os: ubuntu-latest
            category: error
          - system: x86_64-linux
            os: ubuntu-latest
            category: integration
          - system: x86_64-linux
            os: ubuntu-latest
            category: performance
          - system: x86_64-linux
            os: ubuntu-latest
            category: security
          - system: x86_64-linux
            os: ubuntu-latest
            category: unit
          - system: x86_64-linux
            os: ubuntu-latest
            category: module
          - system: x86_64-linux
            os: ubuntu-latest
            category: validation
          - system: x86_64-linux
            os: ubuntu-latest
            category: documentation

          # macOS - Run subset of important tests
          - system: aarch64-darwin
            os: macos-latest
            category: happy
          - system: aarch64-darwin
            os: macos-latest
            category: integration
          - system: aarch64-darwin
            os: macos-latest
            category: unit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
        with:
          extra-conf: |
            extra-platforms = ${{ matrix.system }}

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Run tests - ${{ matrix.category }}
        id: run_tests
        run: |
          chmod +x ./run-tests.sh
          
          # Create output directory for logs
          mkdir -p test-output
          
          echo "::group::üß™ Running ${{ matrix.category }} tests on ${{ matrix.system }}"
          
          # Run tests with timing and structured output
          START_TIME=$(date +%s)
          
          # Run tests and capture both stdout and stderr
          if ./run-tests.sh --category ${{ matrix.category }} --system ${{ matrix.system }} --verbose 2>&1 | tee test-output/${{ matrix.category }}-${{ matrix.system }}.log; then
            TEST_STATUS="passed"
            EXIT_CODE=0
          else
            TEST_STATUS="failed"
            EXIT_CODE=1
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "::endgroup::"
          
          # Save test metadata
          echo "$TEST_STATUS" > test-output/${{ matrix.category }}-status.txt
          echo "$DURATION" > test-output/${{ matrix.category }}-duration.txt
          
          # Count individual tests if possible
          LOG_FILE="test-output/${{ matrix.category }}-${{ matrix.system }}.log"
          PASSED_TESTS=$(grep -c "‚úì" "$LOG_FILE" 2>/dev/null || echo "0")
          FAILED_TESTS=$(grep -c "‚úó" "$LOG_FILE" 2>/dev/null || echo "0")
          echo "$PASSED_TESTS" > test-output/${{ matrix.category }}-passed.txt
          echo "$FAILED_TESTS" > test-output/${{ matrix.category }}-failed.txt
          
          # Create detailed summary for this category
          {
            echo "## üìä Test Results: ${{ matrix.category }}"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            if [ "$TEST_STATUS" = "passed" ]; then
              echo "| Status | ‚úÖ **Passed** |"
            else
              echo "| Status | ‚ùå **Failed** |"
            fi
            echo "| Duration | ‚è±Ô∏è ${DURATION}s |"
            echo "| System | üñ•Ô∏è ${{ matrix.system }} |"
            if [ $PASSED_TESTS -gt 0 ] || [ $FAILED_TESTS -gt 0 ]; then
              TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))
              echo "| Tests Passed | ‚úÖ $PASSED_TESTS/$TOTAL_TESTS |"
            fi
            echo ""
          } >> $GITHUB_STEP_SUMMARY
          
          # Add annotations for failures with more detail
          if [ "$TEST_STATUS" = "failed" ]; then
            echo "::error title=Test Failure (${{ matrix.category }})::$FAILED_TESTS test(s) failed in category ${{ matrix.category }} on ${{ matrix.system }}. Duration: ${DURATION}s"
            
            # Extract and display failed test names
            echo "::group::‚ùå Failed Tests in ${{ matrix.category }}"
            if grep -q "‚úó" "$LOG_FILE"; then
              echo "Failed tests:"
              grep "‚úó" "$LOG_FILE" | head -20 || true
              
              # Also try to extract error messages
              echo ""
              echo "Error details:"
              grep -A 5 "error:" "$LOG_FILE" | head -50 || echo "No detailed error messages found"
            else
              echo "Test suite failed but no individual test failures detected."
              echo "This might be a build or evaluation error."
              echo ""
              echo "Last 30 lines of output:"
              tail -30 "$LOG_FILE"
            fi
            echo "::endgroup::"
            
            # Add failed test details to summary
            {
              echo "### ‚ùå Failed Tests"
              echo ""
              echo "<details>"
              echo "<summary>Click to see failed tests</summary>"
              echo ""
              echo "\`\`\`"
              grep "‚úó" "$LOG_FILE" | head -20 || echo "No specific test failures found"
              echo "\`\`\`"
              echo ""
              echo "</details>"
              echo ""
            } >> $GITHUB_STEP_SUMMARY
          else
            echo "::notice title=Tests Passed (${{ matrix.category }})::All tests in category ${{ matrix.category }} passed in ${DURATION}s"
          fi
          
          exit $EXIT_CODE
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.category }}-${{ matrix.system }}
          path: test-output/
          retention-days: 7

  # Full integration test on primary platform
  full-check:
    name: Full Flake Check (x86_64-linux)
    runs-on: ubuntu-latest
    needs: test-suite
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Run full flake check
        id: full_check
        run: |
          echo "::group::Full Flake Check"
          START=$(date +%s)
          
          if nix flake check --system x86_64-linux --show-trace --print-build-logs; then
            END=$(date +%s)
            DURATION=$((END - START))
            echo "::endgroup::"
            echo "‚úÖ Full flake check passed (${DURATION}s)"
            echo "::notice title=Full Check Passed::Complete flake check passed in ${DURATION}s"
            
            echo "## üîç Full Flake Check" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ All checks passed (${DURATION}s)" >> $GITHUB_STEP_SUMMARY
          else
            END=$(date +%s)
            DURATION=$((END - START))
            echo "::endgroup::"
            echo "::error title=Full Check Failed::Flake check failed after ${DURATION}s"
            exit 1
          fi

  # Report test results
  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [smoke-test, test-suite, full-check]
    if: always()
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Download all test artifacts
        if: always()
        uses: actions/download-artifact@v4
        with:
          path: test-results
          pattern: test-logs-*
      
      - name: Generate comprehensive test report
        id: generate_report
        if: always()
        run: |
          # Create report file for PR comment
          REPORT_FILE="test-report.md"
          
          # Header for both step summary and PR comment
          cat > "$REPORT_FILE" << 'EOF'
# üìä Signal-Nix Test Suite Results

EOF
          
          echo "**Workflow**: ${{ github.workflow }}" >> "$REPORT_FILE"
          echo "**Commit**: \`${{ github.sha }}\`" >> "$REPORT_FILE"
          echo "**Branch**: \`${{ github.ref_name }}\`" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          # Overall status
          SMOKE_STATUS="${{ needs.smoke-test.result }}"
          SUITE_STATUS="${{ needs.test-suite.result }}"
          CHECK_STATUS="${{ needs.full-check.result }}"
          
          if [ "$SMOKE_STATUS" == "success" ] && [ "$SUITE_STATUS" == "success" ] && [ "$CHECK_STATUS" == "success" ]; then
            echo "## ‚úÖ All Tests Passed!" >> "$REPORT_FILE"
            OVERALL_RESULT="success"
            EMOJI="üéâ"
          else
            echo "## ‚ùå Some Tests Failed" >> "$REPORT_FILE"
            OVERALL_RESULT="failure"
            EMOJI="‚ö†Ô∏è"
          fi
          echo "" >> "$REPORT_FILE"
          
          # Quick summary for PR comment (before detailed tables)
          if [ "$OVERALL_RESULT" == "success" ]; then
            echo "> ‚úÖ All test stages passed successfully!" >> "$REPORT_FILE"
          else
            echo "> ‚ùå One or more test stages failed. See details below." >> "$REPORT_FILE"
          fi
          echo "" >> "$REPORT_FILE"
          
          # Test stage summary table
          echo "### üß™ Test Stages" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "| Stage | Status | Description |" >> "$REPORT_FILE"
          echo "|-------|--------|-------------|" >> "$REPORT_FILE"
          
          # Smoke test
          if [ "$SMOKE_STATUS" == "success" ]; then
            echo "| üî• Smoke Tests | ‚úÖ **Passed** | Quick validation successful |" >> "$REPORT_FILE"
          else
            echo "| üî• Smoke Tests | ‚ùå **Failed** | Basic checks failed |" >> "$REPORT_FILE"
          fi
          
          # Test suite
          if [ "$SUITE_STATUS" == "success" ]; then
            echo "| üß™ Test Suite | ‚úÖ **Passed** | All categories passed |" >> "$REPORT_FILE"
          else
            echo "| üß™ Test Suite | ‚ùå **Failed** | One or more categories failed |" >> "$REPORT_FILE"
          fi
          
          # Full check
          if [ "$CHECK_STATUS" == "success" ]; then
            echo "| üîç Full Check | ‚úÖ **Passed** | Complete flake check successful |" >> "$REPORT_FILE"
          else
            echo "| üîç Full Check | ‚ùå **Failed** | Flake check failed |" >> "$REPORT_FILE"
          fi
          
          echo "" >> "$REPORT_FILE"
          
          # Detailed category results from test suite
          if [ -d "test-results" ]; then
            echo "### üìã Detailed Test Results" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            
            # Count passed and failed categories and individual tests
            passed_count=0
            failed_count=0
            failed_categories=""
            total_tests_passed=0
            total_tests_failed=0
            
            for result_dir in test-results/test-logs-*; do
              if [ -d "$result_dir" ]; then
                dir_name=$(basename "$result_dir")
                info="${dir_name#test-logs-}"
                category=$(echo "$info" | sed 's/-[^-]*$//')
                
                status_file="$result_dir/${category}-status.txt"
                passed_file="$result_dir/${category}-passed.txt"
                failed_file="$result_dir/${category}-failed.txt"
                
                # Count individual tests
                if [ -f "$passed_file" ]; then
                  cat_passed=$(cat "$passed_file")
                  total_tests_passed=$((total_tests_passed + cat_passed))
                fi
                if [ -f "$failed_file" ]; then
                  cat_failed=$(cat "$failed_file")
                  total_tests_failed=$((total_tests_failed + cat_failed))
                fi
                
                if [ -f "$status_file" ]; then
                  status=$(cat "$status_file")
                  if [ "$status" == "passed" ]; then
                    ((passed_count++))
                  else
                    ((failed_count++))
                    if [ -n "$failed_categories" ]; then
                      failed_categories="$failed_categories, \`$category\`"
                    else
                      failed_categories="\`$category\`"
                    fi
                  fi
                fi
              fi
            done
            
            total_categories=$((passed_count + failed_count))
            total_tests=$((total_tests_passed + total_tests_failed))
            
            echo "**Categories**: $passed_count/$total_categories passed" >> "$REPORT_FILE"
            if [ $total_tests -gt 0 ]; then
              echo "**Individual Tests**: $total_tests_passed/$total_tests passed" >> "$REPORT_FILE"
            fi
            if [ $failed_count -gt 0 ]; then
              echo "" >> "$REPORT_FILE"
              echo "‚ö†Ô∏è **Failed categories**: $failed_categories" >> "$REPORT_FILE"
            fi
            echo "" >> "$REPORT_FILE"
            
            echo "| Category | System | Status | Duration | Tests | Details |" >> "$REPORT_FILE"
            echo "|----------|--------|--------|----------|-------|---------|" >> "$REPORT_FILE"
            
            # Process each category result
            for result_dir in test-results/test-logs-*; do
              if [ -d "$result_dir" ]; then
                # Extract category and system from directory name
                dir_name=$(basename "$result_dir")
                info="${dir_name#test-logs-}"
                category=$(echo "$info" | sed 's/-[^-]*$//')
                system=$(echo "$info" | sed 's/.*-//')
                
                # Read status and duration if available
                status_file="$result_dir/${category}-status.txt"
                duration_file="$result_dir/${category}-duration.txt"
                passed_file="$result_dir/${category}-passed.txt"
                failed_file="$result_dir/${category}-failed.txt"
                log_file="$result_dir/${category}-${system}.log"
                
                # Get test counts
                test_info="‚Äî"
                if [ -f "$passed_file" ] && [ -f "$failed_file" ]; then
                  passed=$(cat "$passed_file")
                  failed=$(cat "$failed_file")
                  total=$((passed + failed))
                  if [ $total -gt 0 ]; then
                    test_info="$passed/$total"
                  fi
                fi
                
                if [ -f "$status_file" ]; then
                  status=$(cat "$status_file")
                  if [ "$status" == "passed" ]; then
                    status_icon="‚úÖ Passed"
                    details="‚Äî"
                  else
                    status_icon="‚ùå **Failed**"
                    # Try to extract error details from log
                    if [ -f "$log_file" ]; then
                      # Look for common error patterns
                      error_msg=$(grep -m 1 "error:" "$log_file" 2>/dev/null || echo "See artifacts")
                      if [ ${#error_msg} -gt 80 ]; then
                        error_msg="${error_msg:0:77}..."
                      fi
                      details="$error_msg"
                    else
                      details="Check artifacts"
                    fi
                  fi
                else
                  status_icon="‚ö†Ô∏è Unknown"
                  details="‚Äî"
                fi
                
                if [ -f "$duration_file" ]; then
                  duration="$(cat "$duration_file")s"
                else
                  duration="N/A"
                fi
                
                echo "| \`$category\` | \`$system\` | $status_icon | ‚è±Ô∏è $duration | $test_info | $details |" >> "$REPORT_FILE"
              fi
            done
            
            echo "" >> "$REPORT_FILE"
          fi
          
          # Performance summary
          if [ -d "test-results" ]; then
            total_duration=0
            test_count=0
            slowest_test=""
            slowest_duration=0
            
            for duration_file in test-results/test-logs-*/*-duration.txt; do
              if [ -f "$duration_file" ]; then
                duration=$(cat "$duration_file")
                total_duration=$((total_duration + duration))
                test_count=$((test_count + 1))
                
                # Track slowest test
                if [ $duration -gt $slowest_duration ]; then
                  slowest_duration=$duration
                  dir_name=$(dirname "$duration_file")
                  dir_name=$(basename "$dir_name")
                  info="${dir_name#test-logs-}"
                  slowest_test=$(echo "$info" | sed 's/-[^-]*$//')
                fi
              fi
            done
            
            if [ $test_count -gt 0 ]; then
              echo "### ‚ö° Performance Metrics" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              avg_duration=$((total_duration / test_count))
              
              # Format time nicely
              if [ $total_duration -ge 60 ]; then
                minutes=$((total_duration / 60))
                seconds=$((total_duration % 60))
                total_time="${minutes}m ${seconds}s"
              else
                total_time="${total_duration}s"
              fi
              
              echo "- ‚è±Ô∏è **Total test time**: $total_time" >> "$REPORT_FILE"
              echo "- üìä **Categories tested**: $test_count" >> "$REPORT_FILE"
              echo "- üìà **Average per category**: ${avg_duration}s" >> "$REPORT_FILE"
              if [ $slowest_duration -gt 0 ]; then
                echo "- üê¢ **Slowest category**: \`$slowest_test\` (${slowest_duration}s)" >> "$REPORT_FILE"
              fi
              echo "" >> "$REPORT_FILE"
            fi
          fi
          
          # Failed tests section with actionable information
          if [ "$OVERALL_RESULT" == "failure" ]; then
            echo "### üîç Troubleshooting" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**What failed:**" >> "$REPORT_FILE"
            [ "$SMOKE_STATUS" != "success" ] && echo "- ‚ùå Smoke Tests - Basic validation failed" >> "$REPORT_FILE"
            [ "$SUITE_STATUS" != "success" ] && echo "- ‚ùå Test Suite - See category details above" >> "$REPORT_FILE"
            [ "$CHECK_STATUS" != "success" ] && echo "- ‚ùå Full Flake Check - Complete check failed" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Next steps:**" >> "$REPORT_FILE"
            echo "1. üì• Download test logs from the [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$REPORT_FILE"
            echo "2. üîé Check the failed category logs for detailed error messages" >> "$REPORT_FILE"
            echo "3. üèÉ Run locally: \`./run-tests.sh --category <failed-category> --verbose\`" >> "$REPORT_FILE"
            echo "4. üìñ See [docs/troubleshooting.md](https://github.com/${{ github.repository }}/blob/main/docs/troubleshooting.md) for common issues" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          else
            echo "### üéâ Success!" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "All tests passed successfully. Great work! üöÄ" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          fi
          
          # Add footer with helpful links
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "üìö [Documentation](https://github.com/${{ github.repository }}/tree/main/docs) ‚Ä¢ " >> "$REPORT_FILE"
          echo "üß™ [Test Suite Docs](https://github.com/${{ github.repository }}/blob/main/docs/testing.md) ‚Ä¢ " >> "$REPORT_FILE"
          echo "üêõ [Report Issue](https://github.com/${{ github.repository }}/issues/new)" >> "$REPORT_FILE"
          
          # Copy to step summary
          cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          
          # Save result for next step
          echo "result=$OVERALL_RESULT" >> $GITHUB_OUTPUT
          
          # Add error annotation if failed
          if [ "$OVERALL_RESULT" == "failure" ]; then
            echo "::error title=Test Suite Failed::One or more test stages failed. Check the test report for details."
          fi
          
          # Exit with appropriate code
          if [ "$OVERALL_RESULT" == "failure" ]; then
            exit 1
          fi
      
      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'test-report.md';
            
            if (!fs.existsSync(reportPath)) {
              console.log('No report file found, skipping PR comment');
              return;
            }
            
            const report = fs.readFileSync(reportPath, 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üìä Signal-Nix Test Suite Results')
            );
            
            const commentBody = report + '\n\n' + 
              '<sub>ü§ñ This comment is automatically updated on each push.</sub>';
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new PR comment');
            }
